# Week 8A - Finish up Project 1

<hr>

## I. More Firebase - creating a `likes` counter for Dog Names

- ***There is a video of this Firebase demo here --> [Demo - Firebase "Likes" Counter(13:15)](https://rit.hosted.panopto.com/Panopto/Pages/Viewer.aspx?id=d89db2ea-9682-4aef-bb54-ae46002bf7ec)***

## I-A. Overview
- What we are going to build is "likes counter" for user submitted dog names
  - every time a use submits a new dog name, it is added to the `favorites/` path, and given a property of `likes: 1`
  - if this dog name already exists in Firebase, the `likes` property of that dog name is incremented by 1
  - here is a screenshot of the completed example app (on the left), and the Firebase console (on the right)

<hr>

![screenshot](https://github.com/tonethar/IGME-330-Fall-2021/blob/main/_images/gab-dog-1.jpg)

<hr>

### I-A. Start Code

**gab-dog-1-start.html**

```html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>GabDog</title>
  <style>
    *{
      font-family: sans-serif;
    }
  </style>
  <script type="module">

// TODO: ADD YOUR imports and Firebase setup code HERE

//

const writeFavNameData = name => {
  const db = getDatabase();
  const favRef = ref(db, 'favorites/' + name);
  set(favRef, {
      name,
      likes: 1
  });
};

const favoritesChanged = (snapshot) => {
  // TODO: clear #favoritesList
  snapshot.forEach(fav => {
    const childKey = fav.key;
    const childData = fav.val();
    console.log(childKey,childData);
    // TODO: update #favoritesList
  });
};

const init = () => {
  const db = getDatabase();
  const favoritesRef = ref(db, 'favorites/');
  onValue(favoritesRef,favoritesChanged);
	
  btnSubmit.onclick = () => {
    writeFavNameData(nameField.value);
  };
};

init();

</script>
</head>
<body>
  <h1>GabDog&trade;</h1>
  <h3>We want to know - what's a good dog name?</h3>
  <p>Name --> <input value="Rover" id="nameField"></p>
  <button id="btnSubmit">Send Name to Server</button>
  <hr>
  <h3>Popular Names</h3>
  <ol id="favoritesList"></ol>
 </body>
</html>
```

<hr>

### I-B. Notes

**gab-dog-1.html**

#### 1) - Get the basics working

- Add the Firebase/Firebase Realtime Database setup code
- Display the favorite dogs in `#favoritesList` - see screenshot above for an idea of what it should look like - but in this version, we can't record any more "likes" than 1
- The fact we can't increment `likes` on existing dog names is a problem - so let's fix it!

<hr>

#### 2) - Get "`likes ++`" working the "super easy" way

- We'll use the [`ServerValue.increment()`](https://firebase.google.com/docs/reference/kotlin/com/google/firebase/database/ServerValue#increment_1)
- You'll need to `import` this function to use it - add `increment` to your ".../firebase-database.js" import
- Make `writeFavNameData()` look like this - it's only one small change to the code:

```js
const writeFavNameData = name => {
  const db = getDatabase();
  const favRef = ref(db, 'favorites/' + name);
  set(favRef, {
    name,
    likes: increment(1)
  });
};
```

- test it - incrementing `likes` should now work!

<hr>

**gab-dog-2.html**

#### 3) - Get "`likes ++`" working the "harder" way
- This technique will use `get()` and `update()`
- It's not technically needed for this example (because of `increment(1)` above), but this is good to know how to do in case you want to perform updates other than incrementing
- Make a copy of **gab-dog-1.html** and name it **gab-dog-2.html**
- You will need to import `get` and `update` in your ".../firebase-database.js" import
- Here is the new version of `writeFavNameData()` - we will walk though how this code works:

```js
// This is the "harder" way and not necessary for incrementing a counter
// But this code is useful if you want to `get()` a value just once
// and/or do "batch" updates of non-numeric values with `update()`
const writeFavNameData = name => {
  const db = getDatabase();
  const favRef = ref(db, 'favorites/' + name);

  // does it already exist?
  // get will just look once
  get(favRef).then(snapshot => {
    let favorite;
    if (snapshot.exists()) {
      // if it's already in "favorites/" - update the number of likes
      favorite = snapshot.val();
      console.log("found - current values=",favorite);
      const likes = favorite.likes + 1;
      const newData = {
        name,
        likes
      };
      const updates = {};
      updates['favorites/' + name] = newData;
      update(ref(db), updates);
    } else {
      // if it does not exist, add to "mostFavorited/"
      console.log(`No favorite of key='${name}' found`);
      console.log("favorite=",favorite);
      set(favRef, {
        name,
        likes: 1
      });
    }
  }).catch((error) => {
    console.error(error);
  });
}
```


<hr>

### I-C. Documentation
- `increment(value)`
  - *Returns a placeholder value that can be used to atomically increment the current database value by the provided delta.*
  - https://firebase.google.com/docs/reference/kotlin/com/google/firebase/database/ServerValue#increment_1
- `get(path)`
   - *Gets the most up-to-date result for this query.*
   - https://firebase.google.com/docs/reference/js/database.md#get
   - returns a *Promise* - remember those?
 - `update(path,values)`
   - *Writes multiple values to the Database at once.*
   - https://firebase.google.com/docs/reference/js/database.md#update
   - returns a *Promise* - remember those?

<hr>

## I. Project 1 Questions?

- [Project 1 - Final Requirements](../projects/p1-final.md)

<hr>

## II. Project 1 Helpers

### II-A. Creating a `likes` counter

- [4 - More Firebase - creating a likes counter for Dog names](https://github.com/tonethar/IGME-330-Master/blob/master/notes/firebase-4.md)
- ***There is a video of the above Firebase demo here --> [Demo - Firebase "Likes" Counter(13:15)](https://rit.hosted.panopto.com/Panopto/Pages/Viewer.aspx?id=d89db2ea-9682-4aef-bb54-ae46002bf7ec)***

### II-B. "All your web components must take a *parameter*"

- They must have a *parameter* that is passed in via attribute(s), slot(s) and/or as an object property
- This means that components like the one below are NOT acceptable for Project 1

**hello-world.js**

```js
const template = document.createElement("template");
template.innerHTML = "<p>Hello World</p>";

class HelloWorld extends HTMLElement{
  constructor(){
    super();
    this.attachShadow({mode: "open"});
    this.shadowRoot.appendChild(template.content.cloneNode(true));
  }
} 

customElements.define("hello-world", HelloWorld);
```

### II-C. Suggestion - create a *firebase.js* code module

- Below is a Project 1 code snippet that some of you might find useful
- Because your Firebase code will need to be utilized by both your **app.html** page (for example to WRITE the userâ€™s favorites to the cloud) and your **community.html** page (to READ the "most liked by everyone" favorites from the cloud) - that Firebase code should probably be broken out into a separate JS code module named **firebase.js**
- Then the necessary Firebase functionality can then be imported into **app.js** and **community.js** as needed - here is the code from the *Dog Finder* example:

**firebase.js**

```js
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
// https://firebase.google.com/docs/web/setup#available-libraries
import { getDatabase, ref, set, push, onValue, increment } from  "https://www.gstatic.com/firebasejs/9.6.7/firebase-database.js";

// Your web app's Firebase configuration
const firebaseConfig = {
  // PUT YER CREDENTIALS HERE
};

const likedDogsPath = "df-liked-dogs/";

const pushLikedDogToCloud = dog => {
  dog.likes = increment(1);
  const db = getDatabase();
  const favRef = ref(db, `${likedDogsPath}${dog.hash}`);
  set(favRef, dog); // `dog` is an object with `.title`, `.url`, `.likes` properties etc
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
console.log(app);
const db = getDatabase();

export {db,likedDogsPath,ref,set,push,pushLikedDogToCloud,onValue};
```

### II-D. Sorting and filtering your results

- use `array.sort()` and `array.filter()`


<hr><hr>

| <-- Previous Unit | Home | Next Unit -->
| --- | --- | --- 
| [**Week 7B Notes**](07B.md)     |  [**IGME-330 Schedule**](../schedule.md) | [**Week 8B Notes**](08B.md) 
